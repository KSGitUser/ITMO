<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fina project cart</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
  </head>
  <body>
    <div id="app">Handlebars</div>

    <script class="shop-budjet" type="text/x-handlebars-template">
      <div calss='shop-budjet__wrapper'>
        <span>
          Бюджет :
        </span>
        <span class='shop-budjet__amount' contenteditable='true'>
          {{this}}
        </span>
      </div>
    </script>

    <script class="shop-item" type="text/x-handlebars-template">
      {{#each this}}
        <div data-index={{index}} class='shop-item__wrapper'>
          <span class='shop-item__name'>
            {{title}}
          </span>
          <span class='shop-item__price'>
            {{price}}
          </span>
          <button class='shop-item__button' data-index={{index}}>
            В корзину
          </button>
        </div>
      {{/each}}

      <div class='shop-cart__wrapper'>
        <h3>
          Корзина
        </h3>
        <div class='shop-cart__content'></div>
      </div>
    </script>
    <script class="cart-item" type="text/x-handlebars-template">
      {{#each this}}
        <div class='cart-item__line'>
          <span class='cart-item__line-name'>
            {{title}}
          </span>
          <span class='cart-item__line-price'>
            {{price}}
          </span>
          <span class='cart-item__line-price'>
            {{count}}
          </span>
        </div>
      {{/each}}
    </script>
    <script>
      (async () => {
        let cartData = [];
        let shopData = null;
        let amount = 150;

        let source = $('.shop-budjet').html();
        let template = Handlebars.compile(source);
        let html = template(amount);
        $('#app').append(html);

        $('.shop-budjet__amount').on('blur', (ev) => {
          console.log(ev.target.innerText);
          ev.target.innerText = +ev.target.innerText ? +ev.target.innerText : 0;
        });

        await $.ajax({
          url: 'https://kodaktor.ru/cart_data.json',
          method: 'GET',
        })
          .done((data) => (shopData = data))
          .fail((error) => console.error(error));
        const preparedArray = Object.keys(shopData).map((key, index) => {
          return { index, title: key, price: shopData[key] };
        });
        source = $('.shop-item').html();
        template = Handlebars.compile(source);
        html = template(preparedArray);
        $('#app').append(html);
        $('.shop-item__button').each(function () {
          $(this).on('click', (ev) => {
            ev.stopPropagation();
            const cartItemSource = $('.cart-item').html();
            const cartItemTemplate = Handlebars.compile(cartItemSource);

            const foundCartItem = cartData.find(
              (item) => item.index === +ev.target.dataset.index
            );
            const amountData = +$('.shop-budjet__amount').html();
            console.log('typeof amount =>', typeof amountData);

            amount = amountData;

            if (foundCartItem) {
              if (amount - foundCartItem.price >= 0) {
                foundCartItem.count += 1;
                amount -= foundCartItem.price;
              }
            } else {
              const itemToAdd = preparedArray[+ev.target.dataset.index];
              if (amount - itemToAdd.price >= 0) {
                cartData.push({ ...itemToAdd, count: 1 });
                amount -= itemToAdd.price;
              }
            }
            console.log('amount =>', amount);
            $('.shop-budjet__amount').html(amount);
            const cartHtml = cartItemTemplate(cartData);
            $('.shop-cart__content').html(cartHtml);
          });
        });
        console.dir(html);
      })();
    </script>
  </body>
</html>
